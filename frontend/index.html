<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Skill Test Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
    <body>
        <main class="page">
            <header class="hero">
                <p class="eyebrow">DevOps Simulator</p>
                <h1>Skill Test Hub</h1>
            <p class="lead">
                Choose a category to warm up your DevOps instincts. 
            </p>
            <div class="user-row">
                <p class="user-status" id="user-status"></p>
                <button type="button" id="logout-button" class="ghost-btn" hidden>Log Out</button>
            </div>
        </header>

            <section class="grid" id="categories-grid" aria-label="Skill Test Categories"></section>
            <noscript>
                <p>Please enable JavaScript to view available skill tests.</p>
            </noscript>
        </main>

        <div class="auth-overlay" id="auth-overlay">
            <div class="auth-modal" role="dialog" aria-labelledby="auth-title" aria-modal="true">
                <h2 id="auth-title">Welcome back</h2>
                <p>Register a new account or log in to continue.</p>
                <label class="auth-field">
                    Username
                    <input type="text" id="auth-username" name="username" autocomplete="username" required>
                </label>
                <label class="auth-field">
                    Password
                    <input type="password" id="auth-password" name="password" autocomplete="current-password" required>
                </label>
                <div class="modal-actions">
                    <button type="button" id="register-button">Register</button>
                    <button type="button" id="login-button" class="primary-btn">Log In</button>
                </div>
                <p id="auth-status" role="status" aria-live="polite"></p>
            </div>
        </div>

        <!-- Optional server-provided data; parsing is guarded to avoid runtime errors if templating is not applied -->
        <script id="skill-tests-data" type="application/json">{{ skill_tests | tojson | safe }}</script>
        <script>
            const categoriesGrid = document.getElementById('categories-grid');
            const overlay = document.getElementById('auth-overlay');
            const usernameInput = document.getElementById('auth-username');
            const passwordInput = document.getElementById('auth-password');
            const registerBtn = document.getElementById('register-button');
            const loginBtn = document.getElementById('login-button');
            const statusEl = document.getElementById('auth-status');
            const userStatus = document.getElementById('user-status');
            const logoutBtn = document.getElementById('logout-button');

            const fallbackCategories = [
                {
                    name: 'File Type Identification',
                    description: 'Explore how well you know core DevOps file formats and their use in common pipelines.'
            },
            {
                name: 'Terminal',
                description: 'Simulate on-the-spot CLI tasks that validate navigation and command mastery.'
            },
            {
                name: 'Python Virtual Environments and Maven',
                description: 'Tackle mixed-environment workflows, from venv activation to Maven lifecycle knowledge.'
            },
            {
                name: 'Deploy on AWS',
                description: 'Walk through high-level deployment considerations and the services needed to ship safely.'
            }
        ];

        const parseSkillTests = () => {
            const dataEl = document.getElementById('skill-tests-data');
            if (!dataEl) return [];
            try {
                const parsed = JSON.parse(dataEl.textContent);
                return Array.isArray(parsed) ? parsed : [];
            } catch (_err) {
                return [];
            }
        };

        const renderCategories = (items) => {
                categoriesGrid.innerHTML = '';
                items.forEach(({ name, description }) => {
                    const card = document.createElement('article');
                    card.className = 'card';
                    card.innerHTML = `
                    <p class="card-eyebrow">Skill Test</p>
                    <h2>${name}</h2>
                    <p>${description}</p>
                    <button type="button" aria-label="Open ${name} test">Preview</button>
                `;
                categoriesGrid.appendChild(card);
            });
        };

            const categories = (() => {
                const fromServer = parseSkillTests();
                return fromServer.length ? fromServer : fallbackCategories;
            })();

            renderCategories(categories);

            const setUser = (user) => {
                if (!user) return;
                localStorage.setItem('quizUser', JSON.stringify(user));
                userStatus.textContent = `Logged in as ${user.username}`;
                logoutBtn.removeAttribute('hidden');
            };

            const showOverlay = () => {
                overlay.removeAttribute('hidden');
                statusEl.textContent = '';
                passwordInput.value = '';
                usernameInput.focus();
                logoutBtn.setAttribute('hidden', '');
                userStatus.textContent = '';
            };

            const hideOverlay = () => {
                overlay.setAttribute('hidden', '');
                statusEl.textContent = '';
                passwordInput.value = '';
            };

            const apiBase = (() => {
                // If served from a static server (e.g., 5500), point to Flask on 8000
                if (location.port && location.port !== "8000") {
                    return "http://127.0.0.1:8000";
                }
                return "";
            })();

            const handleAuth = async (mode) => {
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                if (!username || !password) {
                    statusEl.textContent = 'Both username and password are required.';
                    return;
                }
                statusEl.textContent = mode === 'register' ? 'Registering...' : 'Logging in...';

                try {
                    const response = await fetch(`${apiBase}/api/${mode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    let payload = {};
                    try {
                        payload = await response.json();
                    } catch (_parseErr) {
                        // leave payload empty for error handling
                    }
                    if (!response.ok) {
                        statusEl.textContent = payload.error || `Server error (${response.status}).`;
                        return;
                    }
                    const { user } = payload;
                    setUser(user);
                    hideOverlay();
                } catch (_err) {
                    statusEl.textContent = 'Network error. Please try again.';
                }
            };

            registerBtn.addEventListener('click', () => handleAuth('register'));
            loginBtn.addEventListener('click', () => handleAuth('login'));

            logoutBtn.addEventListener('click', async () => {
                try {
                    await fetch(`${apiBase}/api/logout`, { method: 'POST', credentials: 'include' });
                } catch (_err) {
                    // ignore network issues on logout
                }
                localStorage.removeItem('quizUser');
                showOverlay();
            });

            // Show modal on first visit; prefill username if stored
            const storedUser = (() => {
                try {
                    return JSON.parse(localStorage.getItem('quizUser') || 'null');
                } catch (_err) {
                    return null;
                }
            })();
            if (storedUser) {
                usernameInput.value = storedUser.username;
                setUser(storedUser);
                hideOverlay();
            } else {
                showOverlay();
            }
        </script>
    </body>
    </html>
